<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appelsap Pro - Full Engine</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }
        
        /* UI LAYERS */
        #ui-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .interactive { pointer-events: auto; }

        #menu-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 15, 0.9); display: flex; justify-content: center; align-items: center; z-index: 100;
        }

        .main-panel {
            background: #121225; padding: 40px; border-radius: 30px; border: 5px solid #a855f7;
            text-align: center; color: white; width: 500px; box-shadow: 0 0 60px rgba(168, 85, 247, 0.4);
        }

        .control-row { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; }
        
        .btn {
            background: #a855f7; border: none; color: white; padding: 12px 20px;
            border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        .btn:hover { background: #c084fc; transform: scale(1.05); }
        .btn.active { background: #22c55e; box-shadow: 0 0 15px #22c55e; }

        #crosshair {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 12px; height: 12px; border: 2px solid white; border-radius: 50%;
            display: none; opacity: 0.5;
        }

        #hud { position: absolute; top: 20px; width: 100%; text-align: center; color: white; font-size: 2em; font-weight: bold; text-shadow: 2px 2px #000; }
    </style>
</head>
<body>

<div id="ui-wrapper">
    <div id="hud">SCORE: <span id="score">0</span></div>
    <div id="crosshair"></div>
</div>

<div id="menu-overlay">
    <div class="main-panel interactive">
        <h1 style="color: #fca311; font-size: 3em; margin-bottom: 10px;">APPELSAP</h1>
        <p style="margin-bottom: 30px; opacity: 0.7;">Refined Physics & Customization</p>

        <div class="control-row">
            <span>Character Kleur:</span>
            <input type="color" id="color-input" value="#0077b6" style="cursor:pointer; width:50px; height:30px;">
        </div>

        <div class="control-row">
            <span>Moeilijkheid:</span>
            <div>
                <button class="btn diff-btn" onclick="updateDiff('easy', this)">EASY</button>
                <button class="btn diff-btn active" onclick="updateDiff('medium', this)">MED</button>
                <button class="btn diff-btn" onclick="updateDiff('hard', this)">HARD</button>
                <button class="btn diff-btn" onclick="updateDiff('insane', this)">INSANE</button>
            </div>
        </div>

        <div class="control-row">
            <span>Zicht:</span>
            <button class="btn" onclick="toggleView()" id="view-btn">3rd PERSON</button>
        </div>

        <div class="control-row">
            <span>Shiftlock:</span>
            <button class="btn" onclick="toggleSL()" id="sl-btn">OFF</button>
        </div>

        <button class="btn" id="start-btn" style="width: 100%; padding: 20px; font-size: 1.5em; margin-top: 20px; background: #22c55e;">START RUN</button>
    </div>
</div>

<script>
    // --- 1. CORE VARIABLES ---
    let scene, camera, renderer, world;
    let playerBody, playerMesh, torsoMesh;
    let yaw = new THREE.Object3D(), pitch = new THREE.Object3D();
    let score = 0, lastPlatformZ = 0;
    
    // Objects arrays
    let platformObjects = [], laserObjects = [];
    
    // --- 2. SETTINGS & STATE ---
    let isFirstPerson = false, shiftlock = false;
    let activeDiff = "medium";
    const diffMap = {
        easy: { gap: [3, 5], width: 12, speed: 10, laser: 0 },
        medium: { gap: [6, 9], width: 9, speed: 13, laser: 0.1 },
        hard: { gap: [9, 13], width: 6, speed: 16, laser: 0.3 },
        insane: { gap: [13, 18], width: 3.5, speed: 20, laser: 0.6 }
    };

    const keys = { w: false, a: false, s: false, d: false, space: false, ArrowLeft: false, ArrowRight: false };
    let canJump = false, wallContactNormal = new CANNON.Vec3();

    // --- 3. INITIALIZATION ---
    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050510);
        scene.fog = new THREE.Fog(0x050510, 20, 140);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Camera Setup with Mouse/Key Control Parent
        scene.add(yaw);
        yaw.add(pitch);
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        pitch.add(camera);

        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(10, 50, 10);
        light.castShadow = true;
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x404040, 0.6));

        initPhysics();
        setupPlayer();
        createBaseEnvironment();
        bindInput();
        animate();
    }

    function initPhysics() {
        world = new CANNON.World();
        world.gravity.set(0, -38, 0); // High gravity for snappy gameplay
        world.solver.iterations = 10;
    }

    // --- 4. PLAYER & CHARACTER SYSTEM ---
    function setupPlayer() {
        // Physics Body: Capsule replacement
        const shape = new CANNON.Cylinder(0.5, 0.5, 1.8, 16);
        playerBody = new CANNON.Body({ mass: 5, position: new CANNON.Vec3(0, 5, 0), fixedRotation: true });
        const q = new CANNON.Quaternion();
        q.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), -Math.PI / 2);
        playerBody.addShape(shape, new CANNON.Vec3(), q);
        world.addBody(playerBody);

        // Visual Construction (Better Character)
        playerMesh = new THREE.Group();
        const skin = new THREE.MeshPhongMaterial({ color: 0xffdbac });
        const clothes = new THREE.MeshPhongMaterial({ color: 0x0077b6 });

        const head = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), skin);
        head.position.y = 1.1;
        
        torsoMesh = new THREE.Mesh(new THREE.BoxGeometry(0.7, 0.9, 0.4), clothes);
        torsoMesh.position.y = 0.4;

        const legGeo = new THREE.BoxGeometry(0.25, 0.8, 0.25);
        const lLeg = new THREE.Mesh(legGeo, clothes); lLeg.position.set(-0.2, -0.4, 0);
        const rLeg = new THREE.Mesh(legGeo, clothes); rLeg.position.set(0.2, -0.4, 0);

        playerMesh.add(head, torsoMesh, lLeg, rLeg);
        scene.add(playerMesh);

        // Physics Logic for Jumping
        playerBody.addEventListener('collide', (e) => {
            const contact = e.contact;
            const norm = new CANNON.Vec3();
            if (contact.bi.id === playerBody.id) contact.ni.negate(norm); else norm.copy(contact.ni);

            if (norm.y > 0.5) {
                canJump = true;
                wallContactNormal.set(0,0,0);
            } else if (Math.abs(norm.y) < 0.3) {
                wallContactNormal.copy(norm);
            }
        });
    }

    // --- 5. PROCEDURAL WORLD ---
    function spawnPlatform(x, y, z, w, d, color) {
        const mesh = new THREE.Mesh(new THREE.BoxGeometry(w, 0.8, d), new THREE.MeshStandardMaterial({color: color, emissive: color, emissiveIntensity: 0.1}));
        mesh.position.set(x, y, z);
        mesh.receiveShadow = true;
        scene.add(mesh);

        const body = new CANNON.Body({ mass: 0, position: new CANNON.Vec3(x, y, z) });
        body.addShape(new CANNON.Box(new CANNON.Vec3(w/2, 0.4, d/2)));
        world.addBody(body);
        platformObjects.push({mesh, body});
    }

    function createBaseEnvironment() {
        spawnPlatform(0, 0, 0, 15, 15, 0x555555);
        lastPlatformZ = -7.5;
        for(let i=0; i<10; i++) generateNext();
    }

    function generateNext() {
        const cfg = diffMap[activeDiff];
        const gap = cfg.gap[0] + Math.random() * (cfg.gap[1] - cfg.gap[0]);
        const nextZ = lastPlatformZ - gap;
        const nextX = (Math.random() - 0.5) * 12;
        const color = new THREE.Color().setHSL(Math.random(), 0.7, 0.5);
        
        spawnPlatform(nextX, (Math.random()-0.5)*2, nextZ, cfg.width, 6, color);
        lastPlatformZ = nextZ - 3;

        if(Math.random() < cfg.laser) spawnLaser(nextZ);
    }

    function spawnLaser(z) {
        const mesh = new THREE.Mesh(new THREE.BoxGeometry(25, 0.3, 0.3), new THREE.MeshBasicMaterial({color: 0xff0000}));
        mesh.position.set(0, 2 + Math.random()*2, z);
        scene.add(mesh);
        laserObjects.push(mesh);
    }

    // --- 6. INPUT & SETTINGS LOGIC ---
    function updateDiff(d, btn) {
        activeDiff = d;
        document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function toggleView() {
        isFirstPerson = !isFirstPerson;
        document.getElementById('view-btn').innerText = isFirstPerson ? "1st PERSON" : "3rd PERSON";
        document.getElementById('crosshair').style.display = isFirstPerson ? "block" : "none";
    }

    function toggleSL() {
        shiftlock = !shiftlock;
        document.getElementById('sl-btn').innerText = shiftlock ? "ON" : "OFF";
    }

    function bindInput() {
        document.getElementById('start-btn').onclick = () => {
            document.getElementById('menu-overlay').style.display = 'none';
            torsoMesh.material.color.set(document.getElementById('color-input').value);
            document.body.requestPointerLock();
        };

        window.addEventListener('keydown', (e) => { if(e.code in keys || e.key in keys) keys[e.code === 'Space' ? 'space' : e.key.toLowerCase()] = true; });
        window.addEventListener('keyup', (e) => { if(e.code in keys || e.key in keys) keys[e.code === 'Space' ? 'space' : e.key.toLowerCase()] = false; });

        document.addEventListener('mousemove', (e) => {
            if (document.pointerLockElement) {
                yaw.rotation.y -= e.movementX * 0.002;
                pitch.rotation.x -= e.movementY * 0.002;
                pitch.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, pitch.rotation.x));
            }
        });
    }

    // --- 7. THE MAIN LOOP ---
    function animate() {
        requestAnimationFrame(animate);
        world.step(1/60);

        // Camera Keyboard Backup (Arrow Keys)
        if(keys.arrowleft) yaw.rotation.y += 0.04;
        if(keys.arrowright) yaw.rotation.y -= 0.04;

        // Player Movement
        const cfg = diffMap[activeDiff];
        const move = new THREE.Vector3();
        if(keys.w) move.z -= 1; if(keys.s) move.z += 1;
        if(keys.a) move.x -= 1; if(keys.d) move.x += 1;
        
        move.applyQuaternion(yaw.quaternion).normalize();
        playerBody.velocity.x = move.x * cfg.speed;
        playerBody.velocity.z = move.z * cfg.speed;

        // FIXED Wall Jump & Physics
        if(keys.space) {
            if(canJump) {
                playerBody.velocity.y = 15;
                canJump = false;
            } else if (wallContactNormal.length() > 0.1) {
                // FIX: Instead of adding force, we SET velocity to avoid physics glitches
                playerBody.velocity.set(wallContactNormal.x * 12, 17, wallContactNormal.z * 12);
                wallContactNormal.set(0,0,0);
            }
            keys.space = false;
        }

        // Camera Logic (Shiftlock/First Person)
        yaw.position.copy(playerBody.position);
        if(shiftlock || isFirstPerson) {
            playerMesh.quaternion.copy(yaw.quaternion);
        }

        if(isFirstPerson) {
            camera.position.set(0, 0.7, 0);
            playerMesh.visible = false;
        } else {
            camera.position.set(0, 5, 12);
            camera.lookAt(playerBody.position.x, playerBody.position.y + 1, playerBody.position.z);
            playerMesh.visible = true;
            playerMesh.position.copy(playerBody.position);
        }

        // Game Loop Logic
        score = Math.max(score, Math.floor(Math.abs(playerBody.position.z)));
        document.getElementById('score').innerText = score;

        if(playerBody.position.z < lastPlatformZ + 60) generateNext();
        if(playerBody.position.y < -20) {
            playerBody.position.set(0, 10, 0);
            playerBody.velocity.set(0,0,0);
            score = 0;
        }

        renderer.render(scene, camera);
    }

    init();
</script>
</body>
</html>
