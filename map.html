<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic School Navigator</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #5c62ec;
            --secondary: #22c55e;
            --background: #f8f9fa;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            padding: 1rem;
        }
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        #mapWrapper {
            position: relative;
            /* Placeholder dimensions based on the map image provided */
            width: 900px; 
            height: 900px; 
            margin: 0 auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: #eee; /* Fallback background */
        }
        #schoolMap {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Ensures the whole map is visible */
        }
        .path-segment {
            position: absolute;
            background-color: var(--secondary);
            z-index: 10;
            opacity: 0.7;
            border-radius: 9999px; /* Fully rounded */
        }
        .start-marker, .end-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            z-index: 20;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
        }
        .start-marker {
            background-color: var(--primary);
        }
        .end-marker {
            background-color: #ef4444; /* Red for destination */
        }
    </style>
</head>
<body>

<div class="app-container">
    <h1 class="text-3xl font-extrabold text-gray-800 mb-4 text-center">üß≠ Dynamic Room Navigator</h1>
    <p class="text-center text-gray-500 mb-6">Find the shortest route and estimated time between any two points in the building.</p>

    <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-6 p-4 bg-gray-50 rounded-lg shadow-inner">
        <div class="w-full sm:w-1/3">
            <label for="startInput" class="block text-sm font-medium text-gray-700">Start Room/Node:</label>
            <input type="text" id="startInput" placeholder="e.g., 0.01 or KEU" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2 border">
        </div>
        <div class="w-full sm:w-1/3">
            <label for="endInput" class="block text-sm font-medium text-gray-700">Destination Room/Node:</label>
            <input type="text" id="endInput" placeholder="e.g., 3.30 or THE" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2 border">
        </div>
        <button onclick="findRoute()" class="w-full sm:w-auto mt-6 px-6 py-2 bg-primary text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90 transition duration-150">
            Calculate Route
        </button>
    </div>

    <div id="routeOutput" class="text-center mb-6 text-lg font-bold text-gray-800"></div>

    <div id="mapWrapper">
        <!-- 
            *** IMPORTANT: The placeholder image URL has been replaced with the provided map image URL. ***
        -->
        <img id="schoolMap" src="https://i.ibb.co/SDRrVsxP/Plattegrond-HWC-2023.png" alt="School Floor Plan">
        <!-- Markers and path segments will be dynamically added here -->
    </div>
    
    <h3 class="text-xl font-bold text-gray-700 mt-8 mb-4">Detailed Directions:</h3>
    <ul id="directionsList" class="list-disc pl-5 text-gray-600 space-y-2">
        <!-- Directions populated here -->
    </ul>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const WALKING_SPEED_SEC_PER_UNIT = 1.0; // 1 second per 'distance unit'
    const MAP_CONTAINER_ID = 'mapWrapper';

    // --- 2. THE MAP GRAPH (NODES, CONNECTIONS, AND COORDINATES) ---
    /*
     * Coordinates are now based on the visual stacking in the image:
     * - Third Floor (Derde Etage) is at the TOP (low Y values, e.g., 100-250)
     * - Ground Floor (Begane Grond) is at the BOTTOM (high Y values, e.g., 550-800)
     * - The X values (left/right) are shared across all floors.
     * You MUST adjust these x/y values for precise marker placement!
     */
    const mapGraph = {
        // --- GROUND FLOOR (Begane Grond) --- Y: ~550 to 800
        '0.01': { connections: { '0.02': 5, 'HALL_G_CENTER': 10 }, floor: 'Ground', x: 600, y: 760, name: 'Room 0.01' },
        '0.02': { connections: { '0.01': 5, '0.03': 6 }, floor: 'Ground', x: 640, y: 760, name: 'Room 0.02' },
        'KEU': { connections: { 'HALL_G_WEST': 20 }, floor: 'Ground', x: 200, y: 700, name: 'Keuken' },
        'THE': { connections: { 'HALL_G_WEST': 30 }, floor: 'Ground', x: 280, y: 800, name: 'Theaterzaal' },
        
        'HALL_G_CENTER': { connections: { '0.01': 10, 'STAIRS_G_N': 20, 'STAIRS_G_W': 50 }, floor: 'Ground', x: 500, y: 700, name: 'Main Hall (G)' },
        'HALL_G_WEST': { connections: { 'KEU': 20, 'THE': 30, 'STAIRS_G_W': 10 }, floor: 'Ground', x: 300, y: 750, name: 'West Hall (G)' },

        // Vertical Connection Nodes (Stairs/Elevator)
        'STAIRS_G_N': { connections: { 'HALL_G_CENTER': 20, 'STAIRS_1_N': 1 }, floor: 'Ground', x: 490, y: 640, name: 'North Stairs/Elevator (G)' },
        'STAIRS_G_W': { connections: { 'HALL_G_WEST': 10, 'STAIRS_1_W': 1 }, floor: 'Ground', x: 400, y: 650, name: 'West Stairs/Elevator (G)' },
        
        // --- FIRST FLOOR (Eerste Etage) --- Y: ~350 to 550
        '1.27': { connections: { '1.26': 5, 'STAIRS_1_N': 15 }, floor: 'First', x: 200, y: 450, name: 'Room 1.27' },
        '1.30': { connections: { '1.31': 8, 'HALL_1_EAST': 10 }, floor: 'First', x: 350, y: 400, name: 'Room 1.30' },
        
        'HALL_1_EAST': { connections: { '1.30': 10, 'STAIRS_1_N': 10 }, floor: 'First', x: 400, y: 400, name: 'East Hall (1)' },
        
        // Vertical Connection Nodes (Stairs/Elevator)
        'STAIRS_1_N': { connections: { 'STAIRS_G_N': 1, '1.27': 15, 'HALL_1_EAST': 10, 'STAIRS_2_N': 1 }, floor: 'First', x: 490, y: 430, name: 'North Stairs/Elevator (1)' },
        'STAIRS_1_W': { connections: { 'STAIRS_G_W': 1, 'STAIRS_2_W': 1, '1.24': 10 }, floor: 'First', x: 400, y: 460, name: 'West Stairs/Elevator (1)' },

        // --- SECOND FLOOR (Tweede Etage) --- Y: ~150 to 350
        '2.30': { connections: { '2.29': 6, 'STAIRS_2_N': 10 }, floor: 'Second', x: 400, y: 200, name: 'Room 2.30' },
        '2.27': { connections: { '2.26': 5, 'HALL_2_WEST': 15 }, floor: 'Second', x: 250, y: 220, name: 'Room 2.27' },
        
        'HALL_2_WEST': { connections: { '2.27': 15, 'STAIRS_2_W': 10 }, floor: 'Second', x: 300, y: 300, name: 'West Hall (2)' },

        // Vertical Connection Nodes (Stairs/Elevator)
        'STAIRS_2_N': { connections: { 'STAIRS_1_N': 1, '2.30': 10, 'STAIRS_3_N': 1 }, floor: 'Second', x: 490, y: 220, name: 'North Stairs/Elevator (2)' },
        'STAIRS_2_W': { connections: { 'STAIRS_1_W': 1, 'HALL_2_WEST': 10, 'STAIRS_3_W': 1 }, floor: 'Second', x: 400, y: 250, name: 'West Stairs/Elevator (2)' },
        
        // --- THIRD FLOOR (Derde Etage) --- Y: ~50 to 150
        '3.30': { connections: { '3.31': 7, 'STAIRS_3_N': 5 }, floor: 'Third', x: 600, y: 100, name: 'Room 3.30' },
        '3.29': { connections: { '3.30': 5, '3.28': 5 }, floor: 'Third', x: 640, y: 100, name: 'Room 3.29' },
        
        // Vertical Connection Nodes (Stairs/Elevator)
        'STAIRS_3_N': { connections: { 'STAIRS_2_N': 1, '3.30': 5 }, floor: 'Third', x: 490, y: 100, name: 'North Stairs/Elevator (3)' },
        'STAIRS_3_W': { connections: { 'STAIRS_2_W': 1 }, floor: 'Third', x: 400, y: 100, name: 'West Stairs/Elevator (3)' }
    };

    // --- 3. DIJKSTRA'S PATHFINDING ALGORITHM ---
    // Finds the shortest path and total distance between two nodes
    function findPath(startNode, endNode) {
        const distances = {};
        const previous = {};
        const nodes = [];

        // Priority Queue implementation (simplified using an array)
        for (let node in mapGraph) {
            distances[node] = Infinity;
            previous[node] = null;
            nodes.push(node);
        }
        distances[startNode] = 0;

        while (nodes.length) {
            nodes.sort((a, b) => distances[a] - distances[b]);
            const smallest = nodes.shift();

            if (smallest === endNode) {
                const path = [];
                let current = endNode;
                while (current) {
                    path.unshift(current);
                    current = previous[current];
                }
                return { path, distance: distances[endNode] };
            }

            if (!smallest || distances[smallest] === Infinity) break;

            for (let neighbor in mapGraph[smallest].connections) {
                const alt = distances[smallest] + mapGraph[smallest].connections[neighbor];
                if (alt < distances[neighbor]) {
                    distances[neighbor] = alt;
                    previous[neighbor] = smallest;
                }
            }
        }
        return { path: null, distance: Infinity };
    }

    // --- 4. VISUALIZATION AND OUTPUT ---

    // Clears all previous markers and path lines
    function clearVisualization() {
        const mapContainer = document.getElementById(MAP_CONTAINER_ID);
        // Remove all dynamically added path segments and markers
        Array.from(mapContainer.querySelectorAll('.path-segment, .start-marker, .end-marker'))
             .forEach(el => el.remove());
    }

    // Draws a line segment between two nodes
    function drawSegment(node1, node2, isStart, isEnd) {
        const mapContainer = document.getElementById(MAP_CONTAINER_ID);
        const { x: x1, y: y1 } = mapGraph[node1];
        const { x: x2, y: y2 } = mapGraph[node2];

        const segment = document.createElement('div');
        segment.className = 'path-segment';
        
        const dx = x2 - x1;
        const dy = y2 - y1;
        const dist = Math.sqrt(dx * dx + dy * dy);
        const angle = Math.atan2(dy, dx);

        // Ensure the path line originates from the center of the start point
        const offsetX = 2; // Half the line thickness
        const offsetY = 2; // Half the line thickness

        segment.style.width = `${dist}px`;
        segment.style.height = '4px'; // Thickness of the path line
        segment.style.left = `${x1}px`;
        segment.style.top = `${y1 - offsetY}px`; // Adjust up by half thickness
        segment.style.transformOrigin = '0 0';
        segment.style.transform = `rotate(${angle}rad)`;

        mapContainer.appendChild(segment);

        // Add a marker at the start node (only once per route calculation)
        if (isStart) {
            const startMarker = document.createElement('div');
            startMarker.className = 'start-marker';
            // Position marker relative to its center (-10px adjustment)
            startMarker.style.left = `${x1 - 10}px`; 
            startMarker.style.top = `${y1 - 10}px`;
            startMarker.innerHTML = 'S';
            mapContainer.appendChild(startMarker);
        }
        
        // Add a marker at the end node (only once at the end)
        if (isEnd) {
            const endMarker = document.createElement('div');
            endMarker.className = 'end-marker';
            endMarker.style.left = `${x2 - 10}px`;
            endMarker.style.top = `${y2 - 10}px`;
            endMarker.innerHTML = 'E';
            mapContainer.appendChild(endMarker);
        }
    }
    
    // Main function to initiate the route search
    function findRoute() {
        clearVisualization();
        const startInput = document.getElementById('startInput').value.toUpperCase().trim();
        const endInput = document.getElementById('endInput').value.toUpperCase().trim();
        const output = document.getElementById('routeOutput');
        const directionsList = document.getElementById('directionsList');
        
        output.innerHTML = '';
        directionsList.innerHTML = '';

        if (!mapGraph[startInput] || !mapGraph[endInput]) {
            output.innerHTML = '<span class="text-red-500">Error: Please enter valid Start and End locations (e.g., 0.01, 2.30, KEU). Valid inputs are: 0.01, 0.02, KEU, THE, 1.27, 1.30, 2.30, 2.27, 3.30, 3.29.</span>';
            return;
        }

        const { path, distance } = findPath(startInput, endInput);

        if (!path) {
            output.innerHTML = '<span class="text-red-500">Error: Could not find a continuous path between these points.</span>';
            return;
        }

        // 1. Calculate Time Estimate
        const estimatedTimeSeconds = distance * WALKING_SPEED_SEC_PER_UNIT;
        const minutes = Math.floor(estimatedTimeSeconds / 60);
        const seconds = Math.round(estimatedTimeSeconds % 60);
        const timeString = `${minutes} min, ${seconds} sec`;

        // 2. Display Route Summary
        output.innerHTML = `‚úÖ **Shortest Route Found!** Total Distance: ${distance.toFixed(0)} units. Estimated Time: <span class="text-secondary">${timeString}</span>`;

        // 3. Draw Route and Directions
        let currentFloor = '';
        let step = 1;
        let lastNode = null;

        for (let i = 0; i < path.length; i++) {
            const node1 = path[i];
            const node2 = path[i + 1];

            // Only draw path segments if there is a next node
            if (node2) {
                const isStart = i === 0;
                const isEnd = i === path.length - 2;

                drawSegment(node1, node2, isStart, isEnd);
            }
            
            const floor1 = mapGraph[node1].floor;
            const name1 = mapGraph[node1].name;
            
            if (floor1 !== currentFloor) {
                // New Floor Transition
                const floorDisplay = floor1 === 'Ground' ? 'Begane Grond' : (floor1 === 'First' ? 'Eerste Etage' : (floor1 === 'Second' ? 'Tweede Etage' : 'Derde Etage'));
                
                const floorChangeLi = document.createElement('li');
                floorChangeLi.className = 'font-bold text-primary mt-2';
                floorChangeLi.innerHTML = `<span class="text-xl">‚û°Ô∏è **BEGIN ON ${floorDisplay.toUpperCase()}**</span>`;
                directionsList.appendChild(floorChangeLi);

                currentFloor = floor1;
            }
            
            // Add direction step (skip the last node which is covered by the last segment draw)
            if (node2) {
                const name2 = mapGraph[node2].name;
                const directionLi = document.createElement('li');
                const distanceSegment = mapGraph[node1].connections[node2];
                let description = `From **${name1}**, walk towards **${name2}**. (${distanceSegment} units)`;

                if (node2.startsWith('STAIRS') && node2.length > 8) { // Check if it's an inter-floor transition
                    description = `Use **${name1}** (Stairs/Elevator) to go to the **${mapGraph[node2].floor}**.`;
                } else if (node1.startsWith('STAIRS') && node1.length > 8) {
                     // If coming out of the stairs, the text should reference the new room/hall
                     description = `Continue from the stairs towards **${name2}**. (${distanceSegment} units)`;
                }
                
                directionLi.innerHTML = `${step++}. ${description}`;
                directionsList.appendChild(directionLi);
            }

            lastNode = node1;
        }
        
        // Final destination step
        const finalLi = document.createElement('li');
        finalLi.className = 'font-bold text-red-500';
        finalLi.innerHTML = `${step}. You have arrived at your destination: **${mapGraph[endInput].name}**!`;
        directionsList.appendChild(finalLi);
    }
</script>

</body>
</html>
