<!DOCTYPE html>
<html>
<head>
    <title>Appeltaart</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #game-box { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; display: none; }
        
        /* Auth Scherm */
        #auth-overlay { position: absolute; width: 100%; height: 100%; background: radial-gradient(circle, #1a1a2e, #020205); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .auth-card { background: rgba(255,255,255,0.05); border: 1px solid #00d4ff; padding: 40px; border-radius: 15px; width: 300px; text-align: center; color: white; backdrop-filter: blur(10px); border: 1px solid rgba(0,212,255,0.3); }
        .auth-card h2 { margin-top: 0; color: #00d4ff; }
        .auth-card input { width: 90%; padding: 12px; margin: 10px 0; border-radius: 5px; border: 1px solid #333; background: #000; color: white; outline: none; }
        .btn-main { width: 100%; padding: 12px; background: #00d4ff; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.3s; }
        .btn-main:hover { background: #fff; }

        /* HUD & UI */
        #ui { position: absolute; z-index: 10; width: 100%; pointer-events: none; color: white; display: none; height: 100%; }
        .panel { pointer-events: auto; background: rgba(0,0,0,0.8); border: 1px solid #00d4ff; padding: 15px; border-radius: 10px; backdrop-filter: blur(5px); }
        #hud { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); text-align: center; min-width: 100px; }
        #leaderboard { position: absolute; right: 20px; top: 20px; width: 220px; }
        .lb-entry { display: flex; justify-content: space-between; font-size: 12px; margin: 5px 0; border-bottom: 1px solid #222; padding-bottom: 2px; }
        #customizer { position: absolute; left: 20px; top: 20px; width: 150px; }
        .toggle-link { font-size: 12px; color: #aaa; cursor: pointer; margin-top: 15px; display: block; text-decoration: underline; }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="auth-card">
        <h2 id="auth-title">Appelsap Online</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Wachtwoord">
        <input type="text" id="username-input" placeholder="Display Naam" style="display:none;">
        <button class="btn-main" id="auth-btn">Inloggen</button>
        <span class="toggle-link" id="toggle-auth">Nog geen account? Registreer</span>
    </div>
</div>

<div id="game-box"></div>
<div id="ui">
    <div id="hud" class="panel">
        <div id="world-name" style="color:#ffcc00; font-size: 11px; font-weight: bold;">NEON VOID</div>
        <div style="font-size: 26px; font-weight: bold;"><span id="dist-val">0</span>m</div>
    </div>
    <div id="leaderboard" class="panel">
        <div style="font-weight: bold; color: #ffcc00; margin-bottom: 10px; text-align: center;">GLOBAL TOP</div>
        <div id="lb-content">Laden...</div>
    </div>
    <div id="customizer" class="panel">
        <div id="display-name" style="font-size: 14px; margin-bottom: 10px; font-weight: bold; color:#00d4ff;">-</div>
        <button id="redeem-btn" style="width:100%; font-size:10px; background:#ffcc00; color:black; border:none; padding: 8px; cursor:pointer; font-weight:bold; border-radius:4px;">REDEEM CODE</button>
        <button id="logout-btn" style="width:100%; font-size:10px; background: #ff4444; border:none; color:white; padding: 8px; cursor:pointer; margin-top:8px; border-radius:4px;">LOGOUT</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBsGNce9U0D74rp06oNBajVEGDA2oQ1YVQ",
        authDomain: "appeltaart-auth.firebaseapp.com",
        projectId: "appeltaart-auth",
        storageBucket: "appeltaart-auth.firebasestorage.app",
        messagingSenderId: "736259678856",
        appId: "1:736259678856:web:cdce57fdcb04e99072b53d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let isSignup = false;

    // --- AUTH FUNCTIES ---
    const toggleAuth = () => {
        isSignup = !isSignup;
        document.getElementById('auth-title').innerText = isSignup ? "Registreren" : "Inloggen";
        document.getElementById('username-input').style.display = isSignup ? "block" : "none";
        document.getElementById('auth-btn').innerText = isSignup ? "Maak Account" : "Inloggen";
        document.getElementById('toggle-auth').innerText = isSignup ? "Al een account? Log in" : "Nog geen account? Registreer";
    };

    const handleAuth = async () => {
        const email = document.getElementById('email').value.trim();
        const pass = document.getElementById('password').value.trim();
        const username = document.getElementById('username-input').value.trim();

        try {
            if (isSignup) {
                if(!username) return alert("Vul een naam in");
                const res = await createUserWithEmailAndPassword(auth, email, pass);
                await updateProfile(res.user, { displayName: username });
                await setDoc(doc(db, "users", res.user.uid), { title: "Survivor" });
            } else {
                await signInWithEmailAndPassword(auth, email, pass);
            }
        } catch (err) { alert(err.message); }
    };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('game-box').style.display = 'block';
            document.getElementById('ui').style.display = 'block';
            document.getElementById('display-name').innerText = (user.displayName || "Speler").toUpperCase();
            
            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                game.currentTitle = userDoc.exists() ? userDoc.data().title : "Survivor";
            } catch(e) { 
                console.log("Fout bij ophalen titel:", e);
                game.currentTitle = "Survivor"; 
            }

            if(!game.isRunning) game.start();
            updateLeaderboard();
        } else {
            document.getElementById('auth-overlay').style.display = 'flex';
        }
    });

    const updateLeaderboard = async () => {
        try {
            const q = query(collection(db, "scores"), orderBy("score", "desc"), limit(5));
            const snap = await getDocs(q);
            let html = "";
            snap.forEach(doc => {
                const data = doc.data();
                const isSpecial = (data.title === "Dev" || data.title === "Bedenker");
                const titleStyle = isSpecial ? "font-weight:bold; color:#00ffcc;" : "color:#ffcc00;";
                html += `<div class="lb-entry"><span style="${titleStyle}">[${data.title || 'Speler'}] ${data.name}</span><span style="color:white">${data.score}m</span></div>`;
            });
            document.getElementById('lb-content').innerHTML = html || "Nog geen scores";
        } catch(e) { console.log("LB Error:", e); }
    };

    window.redeemCode = async () => {
        const code = prompt("Voer code in:").toUpperCase();
        let newTitle = "";
        if(code === "DEV123") newTitle = "Dev";
        else if(code === "CREATOR77") newTitle = "Bedenker";
        else return alert("Ongeldige code");

        if(auth.currentUser) {
            await setDoc(doc(db, "users", auth.currentUser.uid), { title: newTitle }, { merge: true });
            game.currentTitle = newTitle;
            game.updateNameTag();
            alert("Titel aangepast naar: " + newTitle);
        }
    };

    const saveScore = async (score) => {
        if (!auth.currentUser) return;
        await setDoc(doc(db, "scores", auth.currentUser.uid), {
            name: auth.currentUser.displayName || "Anoniem",
            score: score,
            title: game.currentTitle
        }, { merge: true });
        updateLeaderboard();
    };

    // --- GAME ENGINE ---
    const game = {
        isRunning: false, currentTitle: "Survivor",
        keys: {}, platforms: [], lastZ: -8, yaw: 0, velY: 0, gravity: 0.015, speed: 0.25,

        start() {
            this.isRunning = true;
            this.scene = new THREE.Scene();
            this.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            this.renderer = new THREE.WebGLRenderer({ antialias: true });
            this.renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('game-box').innerHTML = ""; // Clear
            document.getElementById('game-box').appendChild(this.renderer.domElement);
            
            this.scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            
            this.player = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.7,0.9,0.4), new THREE.MeshPhongMaterial({color:0x00d4ff}));
            body.position.y = 0.45;
            this.player.add(body);
            this.scene.add(this.player);

            const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 128;
            this.nameTag = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas) }));
            this.nameTag.scale.set(3, 0.75, 1);
            this.scene.add(this.nameTag);

            this.resetWorld();
            
            window.onkeydown = (e) => this.keys[e.code] = true;
            window.onkeyup = (e) => this.keys[e.code] = false;
            document.addEventListener('mousemove', (e) => {
                if(document.pointerLockElement) this.yaw -= e.movementX*0.003;
            });
            document.addEventListener('click', () => {
                if(this.isRunning) document.body.requestPointerLock();
            });

            this.animate();
        },

        updateNameTag() {
            if (!auth.currentUser || !this.nameTag) return;
            const ctx = this.nameTag.material.map.image.getContext('2d');
            ctx.clearRect(0,0,512,128);
            
            const name = auth.currentUser.displayName ? auth.currentUser.displayName.toUpperCase() : "PLAYER";
            ctx.font = "bold 50px Arial"; ctx.fillStyle = "white"; ctx.textAlign = "center";
            ctx.fillText(name, 256, 50);

            ctx.font = "bold 40px Arial";
            if(this.currentTitle === "Dev" || this.currentTitle === "Bedenker") {
                const grad = ctx.createLinearGradient(0,0,512,0);
                const hue = (Date.now() * 0.15) % 360; // Regenboog effect
                grad.addColorStop(0, `hsl(${hue}, 100%, 50%)`);
                grad.addColorStop(0.5, `hsl(${(hue+60)%360}, 100%, 50%)`);
                grad.addColorStop(1, `hsl(${(hue+120)%360}, 100%, 50%)`);
                ctx.fillStyle = grad;
            } else { ctx.fillStyle = "#ffcc00"; }
            
            ctx.fillText(this.currentTitle, 256, 110);
            this.nameTag.material.map.needsUpdate = true;
        },

        resetWorld() {
            this.platforms.forEach(p => this.scene.remove(p));
            this.platforms = [];
            this.player.position.set(0,2,0);
            this.lastZ = -5;
            this.scene.background = new THREE.Color(0x050510);
            this.scene.fog = new THREE.Fog(0x050510, 10, 80);
            
            // Start platform
            const startPlat = new THREE.Mesh(new THREE.BoxGeometry(10,1,10), new THREE.MeshStandardMaterial({color:0x333344}));
            this.scene.add(startPlat);
            this.platforms.push(startPlat);

            for(let i=0; i<15; i++) this.gen();
            this.updateNameTag();
        },

        gen() {
            const nZ = this.lastZ - (7 + Math.random()*7);
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(6,1,6), new THREE.MeshStandardMaterial({color:0x333344}));
            mesh.position.set((Math.random()-0.5)*10, (Math.random()-0.5)*2, nZ);
            this.scene.add(mesh);
            this.platforms.push(mesh);
            this.lastZ = nZ;
        },

        animate() {
            requestAnimationFrame(() => this.animate());
            
            if (this.currentTitle === "Dev" || this.currentTitle === "Bedenker") this.updateNameTag();
            
            // Beweging
            if(this.keys['KeyW']) this.player.position.z -= Math.cos(this.yaw) * this.speed;
            if(this.keys['KeyW']) this.player.position.x -= Math.sin(this.yaw) * this.speed;
            if(this.keys['Space'] && Math.abs(this.velY) < 0.01) this.velY = 0.4;

            this.velY -= this.gravity;
            this.player.position.y += this.velY;

            // Collision
            let grounded = false;
            this.platforms.forEach(p => {
                const dx = Math.abs(this.player.position.x - p.position.x);
                const dz = Math.abs(this.player.position.z - p.position.z);
                if(dx < 3.5 && dz < 3.5 && this.player.position.y - p.position.y > 0 && this.player.position.y - p.position.y < 1) {
                    this.player.position.y = p.position.y + 0.5; this.velY = 0; grounded = true;
                }
            });

            if(this.player.position.z < this.lastZ + 80) this.gen();
            
            const dist = Math.floor(Math.abs(this.player.position.z));
            document.getElementById('dist-val').innerText = dist;
            
            // Camera
            const camDist = 8;
            this.camera.position.set(
                this.player.position.x + Math.sin(this.yaw) * camDist, 
                this.player.position.y + 3, 
                this.player.position.z + Math.cos(this.yaw) * camDist
            );
            this.camera.lookAt(this.player.position.x, this.player.position.y + 1, this.player.position.z);
            this.nameTag.position.set(this.player.position.x, this.player.position.y + 2.5, this.player.position.z);

            if(this.player.position.y < -15) {
                saveScore(dist);
                this.resetWorld();
            }
            this.renderer.render(this.scene, this.camera);
        }
    };

    // Event listeners
    document.getElementById('auth-btn').onclick = handleAuth;
    document.getElementById('logout-btn').onclick = () => signOut(auth).then(() => location.reload());
    document.getElementById('toggle-auth').onclick = toggleAuth;
    document.getElementById('redeem-btn').onclick = () => window.redeemCode();
</script>
</body>
</html>
