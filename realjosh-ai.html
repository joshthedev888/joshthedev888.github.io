<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>realJosh.AI Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6366f1; }
        .whitespace-pre-wrap { white-space: pre-wrap; }
        .image-loading {
            min-height: 100px;
            background-color: #e5eeeb;
            background-image: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
    </style>
</head>
<body class="min-h-screen w-full flex justify-center items-center bg-gray-100 p-0">

    <div id="app-container" class="w-full h-screen flex flex-col rounded-none shadow-none overflow-hidden bg-white">

        <header class="bg-white p-4 sm:p-6 flex flex-col sm:flex-row justify-between items-center border-b border-gray-200 flex-shrink-0 shadow-md">
            
            <div class="flex items-center mb-2 sm:mb-0">
                <svg id="header-cpu-icon" class="w-8 h-8 mr-3 text-indigo-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="5" width="14" height="14" rx="2"/><path d="M15 9V7h-2V5H9v2H7v4h2v2H7v4h2v2h4v-2h2v-2h2v-4h-2v-2h2z"/></svg>
                <h1 class="text-xl sm:text-3xl font-extrabold text-gray-800">
                    realJosh.<span class="text-indigo-600">AI</span> 
                </h1>
            </div>

        <div class="bg-indigo-50 p-3 sm:px-6 text-center text-sm font-medium text-indigo-700 border-b border-indigo-200 flex-shrink-0">
            <strong>Model:</strong> <span id="current-model-info">realJosh.ai v2.0 mini</span>
        </div>
        <div class="flex-1 p-4 sm:p-6 flex flex-col overflow-hidden bg-white">
            <div id="chat-history-container" class="flex-1 overflow-y-auto pr-2 custom-scrollbar">
                <div id="chat-end-ref"></div>
            </div>

            <form id="input-form" class="mt-4 flex flex-shrink-0">
                <input
                    type="text"
                    id="prompt-input"
                    placeholder="Stel je vraag..."
                    class="flex-1 p-4 rounded-l-xl bg-gray-50 text-gray-800 placeholder-gray-400 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 border border-gray-300 border-r-0 transition duration-200"
                    autofocus
                />
                <button
                    type="submit"
                    id="send-button"
                    class="p-4 rounded-r-xl text-white font-semibold flex items-center justify-center transition duration-300 transform active:scale-95 bg-gray-300 text-gray-600 cursor-not-allowed"
                    disabled
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-0 sm:mr-2"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
                    <span class="hidden sm:inline">Verstuur</span>
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        const ICON_MAP = {
            Cpu: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><rect x="5" y="5" width="14" height="14" rx="2"/><path d="M15 9V7h-2V5H9v2H7v4h2v2H7v4h2v2h4v-2h2v-2h2v-4h-2v-2h2z"/></svg>',
            AlertTriangle: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
            Image: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>',
            MessageSquare: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>'
        };

        const PROXY_BASE_URL = 'https://joshthedev888-server.onrender.com/api/';
        const PROXY_PROCESS_ENDPOINT = 'process-request'; 
        
        const MAIN_COLOR = 'text-indigo-600';
        const ACCENT_BUTTON_CLASSES = 'bg-indigo-600 hover:bg-indigo-700 shadow-lg';
        const ACCENT_CLASS_ARRAY = ACCENT_BUTTON_CLASSES.split(' ');
        const ERROR_COLOR = 'text-red-500';

        let chatHistory = [];
        let isTyping = false;
        let isWarmingUp = true;
        
        let selectedModel = 'mini'; 
        let isPremiumUser = false; 

        const chatContainer = document.getElementById('chat-history-container');
        const promptInput = document.getElementById('prompt-input');
        const sendButton = document.getElementById('send-button');
        const inputForm = document.getElementById('input-form');
        const chatEndRef = document.getElementById('chat-end-ref');
        const headerCpuIcon = document.getElementById('header-cpu-icon');
        const modelSelect = document.getElementById('model-select');
        const premiumToggle = document.getElementById('premium-toggle');
        const currentModelInfo = document.getElementById('current-model-info');

        const scrollToBottom = () => {
            chatEndRef.scrollIntoView({ behavior: "smooth" });
        };
        
        const isImageRequest = (prompt) => {
            const lowerPrompt = prompt.toLowerCase();
            return lowerPrompt.includes('maak een afbeelding van') ||
                   lowerPrompt.includes('genereer een afbeelding van') ||
                   lowerPrompt.includes('teken een afbeelding van') ||
                   lowerPrompt.includes('toon een foto van');
        };

        const callProxy = async (endpoint, payload) => {
            const response = await fetch(PROXY_BASE_URL + endpoint, { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            let responseBody;
            try {
                responseBody = await response.json();
            } catch (e) {
                throw new Error(`Server reageerde met niet-JSON data of is offline. HTTP Status: ${response.status}`);
            }

            if (!response.ok) {
                const error = new Error(responseBody.error || `Onbekende HTTP-fout: ${response.status}`);
                error.status = response.status;
                error.premiumRequired = responseBody.premiumRequired;
                error.rateLimited = responseBody.rateLimited;
                error.fallbackText = responseBody.fallbackText; 
                throw error;
            }
            
            return responseBody;
        };
        
        const callProcessRequestAPI = async (userPrompt, isWakeUp = false) => {
            const apiHistory = chatHistory
                .filter(msg => msg.sender !== 'ai' || !msg.isError) 
                .filter(msg => msg.type !== 'image') 
                .map(msg => ({
                    role: msg.sender === 'user' ? 'user' : 'model', 
                    parts: [{ text: msg.text }]
                }));
            
            const contents = isWakeUp
                ? [{ role: 'user', parts: [{ text: "Wake up call" }] }]
                : [...apiHistory, { role: 'user', parts: [{ text: userPrompt }] }];

            const payload = {
                contents: contents, 
                isPremium: isPremiumUser, 
            };

            const result = await callProxy(PROXY_PROCESS_ENDPOINT, payload);
            
            if (result.isImage) {
                return {
                    type: 'image',
                    description: result.description,
                    data: result.data,
                    mimeType: result.mimeType,
                };
            } else {
                let text = result.text;
                
                if (result.sources && result.sources.length > 0) {
                    const sourceList = result.sources
                        .map((a, index) => `[${index + 1}] <a href="${a.uri}" target="_blank" class="text-indigo-600 hover:text-indigo-800 underline">${a.title}</a>`)
                        .join('\n');
                    text += `\n\n---\n**Gevonden bronnen:**\n${sourceList}`;
                }

                return {
                    type: 'chat',
                    text: text,
                };
            }
        };
        
        const updateUIState = () => {
            currentModelInfo.textContent = modelSelect.options[modelSelect.selectedIndex].text + (isPremiumUser ? ' (Premium Status: Aan)' : ' (Premium Status: Uit)');

            const promptValue = promptInput.value.trim();
            const isButtonDisabled = isTyping || !promptValue || isWarmingUp;
            const isInputDisabled = isTyping || isWarmingUp;

            if (isButtonDisabled) {
                sendButton.disabled = true;
                sendButton.classList.remove(...ACCENT_CLASS_ARRAY);
                sendButton.classList.add('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');
            } else {
                sendButton.disabled = false;
                sendButton.classList.add(...ACCENT_CLASS_ARRAY);
                sendButton.classList.remove('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');
            }

            promptInput.disabled = isInputDisabled;
            promptInput.placeholder = isWarmingUp ? "Server wordt opgewarmd..." : (isTyping ? "realJosh.ai is bezig met verwerken..." : "Stel je vraag of zeg 'maak een afbeelding van...'");

            if (isTyping || isWarmingUp) {
                headerCpuIcon.classList.add('animate-pulse');
            } else {
                headerCpuIcon.classList.remove('animate-pulse');
            }
        };

        const renderTypingIndicator = (show, isImageMode = false) => {
            const existingIndicator = document.getElementById('typing-indicator');
            if (!show) {
                if (existingIndicator) existingIndicator.remove();
                return;
            }

            if (existingIndicator) return;

            const indicator = document.createElement('div');
            indicator.id = 'typing-indicator';
            indicator.className = 'flex justify-start mb-4 p-2';
            indicator.innerHTML = `
                <div class="p-2 rounded-full mr-3 bg-indigo-100 shadow-md flex-shrink-0 ${MAIN_COLOR}">
                    ${isImageMode ? ICON_MAP.Image : ICON_MAP.Cpu}
                </div>
                <div class="max-w-xs sm:max-w-lg p-4 rounded-xl shadow-lg transition duration-300 bg-gray-200 text-gray-700 rounded-tl-none border border-gray-300">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-indigo-600 rounded-full animate-bounce delay-75"></div>
                        <div class="w-2 h-2 bg-indigo-600 rounded-full animate-bounce delay-150"></div>
                        <div class="w-2 h-2 bg-indigo-600 rounded-full animate-bounce delay-300"></div>
                        <span class="text-sm ml-2">${isImageMode ? 'coole afbeelding wordt gegenereerd...' : 'antwoord wordt getikt...'}</span>
                    </div>
                </div>
            `;
            chatContainer.insertBefore(indicator, chatEndRef);
            scrollToBottom();
        };

        const renderImage = (base64Data, mimeType, description) => {
            const messageEl = document.createElement('div');
            messageEl.className = 'flex mb-4 p-2 justify-start';
            messageEl.innerHTML = `
                <div class="p-2 rounded-full mr-3 bg-green-100 shadow-md flex-shrink-0 text-green-600">
                    ${ICON_MAP.Image}
                </div>
                <div class="max-w-xs sm:max-w-lg p-4 rounded-xl shadow-lg transition duration-300 bg-gray-200 text-gray-800 rounded-tl-none border border-gray-300">
                    <p class="mb-2 text-sm font-semibold">${description}</p>
                    <img 
                        src="data:${mimeType};base64,${base64Data}" 
                        alt="Generated by realJosh.ai" 
                        class="mt-2 rounded-lg max-w-full h-auto shadow-md border border-gray-300"
                        loading="lazy"
                    />
                    <p class="mt-2 text-xs text-gray-500">Model: Gemini Pro Image Preview</p>
                </div>
            `;
            chatContainer.insertBefore(messageEl, chatEndRef);
            scrollToBottom();
        };

        const renderMessage = (msg) => {
            const messageEl = document.createElement('div');
            
            const { sender, text, icon: iconName, color, type } = msg;

            if (type === 'image' && sender === 'ai') {
                renderImage(msg.data, msg.mimeType, msg.description);
                return;
            }

            const isError = iconName === 'AlertTriangle';

            const iconSvg = ICON_MAP[iconName] || ICON_MAP.MessageSquare;
            const iconClass = color || MAIN_COLOR;
            const bgColor = isError ? 'bg-red-200' : 'bg-gray-200';
            const textColor = isError ? 'text-red-800' : 'text-gray-800';
            
            if (sender === 'user') {
                messageEl.className = 'flex mb-4 p-2 justify-end';
                messageEl.innerHTML = `
                    <div class="max-w-xs sm:max-w-lg p-4 rounded-xl shadow-lg transition duration-300 bg-indigo-600 text-white rounded-br-none whitespace-pre-wrap">
                        <p>${text}</p>
                    </div>
                `;
            } else {
                messageEl.className = 'flex mb-4 p-2 justify-start';
                messageEl.innerHTML = `
                    <div class="p-2 rounded-full mr-3 bg-indigo-100 shadow-md flex-shrink-0 ${iconClass}">
                        ${iconSvg}
                    </div>
                    <div class="max-w-xs sm:max-w-lg p-4 rounded-xl shadow-lg transition duration-300 ${bgColor} ${textColor} rounded-tl-none border border-gray-300 whitespace-pre-wrap">
                        <p>${text}</p>
                    </div>
                `;
            }
            chatContainer.insertBefore(messageEl, chatEndRef);
        };

        const renderChatHistory = () => {
            Array.from(chatContainer.children).forEach(child => {
                if (child.id !== 'chat-end-ref' && child.id !== 'typing-indicator') {
                    child.remove();
                }
            });
            
            chatHistory.forEach(renderMessage);
            scrollToBottom();
        };
        
        const handleSend = async (e) => {
            e.preventDefault();
            const cleanPrompt = promptInput.value.trim();
            
            if (!cleanPrompt || isTyping || isWarmingUp) return;

            const userMessage = { sender: 'user', text: cleanPrompt };
            chatHistory.push(userMessage);
            promptInput.value = '';

            const isImageAttempt = isImageRequest(cleanPrompt); 
            const useProModel = selectedModel === 'pro';

            isTyping = true;
            renderChatHistory(); 
            renderTypingIndicator(true, isImageAttempt && useProModel); 
            updateUIState();

            let finalMessage;
            
            try {
                const apiResult = await callProcessRequestAPI(cleanPrompt);
                
                if (apiResult.type === 'image') {
                    finalMessage = {
                        sender: 'ai',
                        type: 'image',
                        description: apiResult.description,
                        data: apiResult.data,
                        mimeType: apiResult.mimeType,
                    };
                } else {
                    finalMessage = {
                        sender: 'ai',
                        type: 'chat',
                        text: apiResult.text,
                        icon: 'Cpu',
                        color: MAIN_COLOR
                    };
                }

                chatHistory.push(finalMessage);

            } catch (error) {
                console.error("Fout in handleSend:", error);
                
                let errorText;
                
                if (error.fallbackText) {
                    errorText = error.fallbackText;
                } else if (error.status === 403 && error.premiumRequired) {
                    errorText = `Yo, de server zegt: **${error.message}**. Je moet Premium inschakelen om deze feature te gebruiken. (Check de 'Premium (Test)' schakelaar hierboven!)`;
                } else if (error.status === 429 && error.rateLimited) {
                    errorText = `Chill, bro! De server is even overbelast met coole afbeeldingen maken. **${error.message}** Probeer het later nog eens!`;
                } else {
                    errorText = `Een probleem is gedetecteerd met de server. Fout: ${error.message}.`;
                }
                
                finalMessage = {
                    sender: 'ai',
                    text: errorText,
                    icon: 'AlertTriangle',
                    color: ERROR_COLOR,
                    isError: true
                };
                chatHistory.push(finalMessage);
                
            } finally {
                isTyping = false;
                renderTypingIndicator(false);
                renderChatHistory();
                updateUIState();
            }
        };

        const wakeUpServer = async () => {
            isWarmingUp = true;
            updateUIState();
            
            const warmUpMessage = { 
                sender: 'ai', 
                text: 'wacht even, de server moet opgestart worden. normaal hoeft dit niet, maar het spaart energie (en dus ook geld). dit hoeft niet elke keer, alleen als dls server voor een tijdje niet gebruikt is.', 
                icon: 'Cpu', 
                color: MAIN_COLOR 
            };
            chatHistory.push(warmUpMessage);
            renderChatHistory(); 
            
            try {
                await callProcessRequestAPI(null, true); 
                console.log("Server opgestart! Klaar voor gebruik.");
            } catch (error) {
                console.error("Fout bij opstarten, maar we gaan door:", error.message);
            } finally {
                isWarmingUp = false;
                
                chatHistory = chatHistory.filter(msg => msg !== warmUpMessage); 

                chatHistory.push({
                    sender: 'ai',
                    text: 'yo ik ben terug vraag of zeg wat je wilt tegen mij',
                    icon: 'Cpu',
                    color: MAIN_COLOR
                });
                
                updateUIState();
                renderChatHistory();
            }
        };

        const init = () => {
            chatHistory = []; 

            inputForm.addEventListener('submit', handleSend);
            promptInput.addEventListener('input', updateUIState);
            
            modelSelect.addEventListener('change', (e) => {
                selectedModel = e.target.value;
                updateUIState();
                chatHistory.push({
                    sender: 'ai',
                    text: `Cool! Je bent nu overgeschakeld naar <strong>${modelSelect.options[modelSelect.selectedIndex].text}</strong>. De server checkt nu je vraag en stuurt de juiste AI (Chat of Beeld) aan. Zeg 'maak een afbeelding van...' om die lijpe feature te testen.`,
                    icon: 'Cpu',
                    color: MAIN_COLOR
                });
                renderChatHistory();
            });

            premiumToggle.addEventListener('change', (e) => {
                isPremiumUser = e.target.checked;
                updateUIState();
                chatHistory.push({
                    sender: 'ai',
                    text: `Pro: is nu ${isPremiumUser ? 'AAN' : 'UIT'}. Je kunt nu ${isPremiumUser ? 'wel' : 'geen'} afbeeldingen genereren met het Pro-model.`,
                    icon: 'AlertTriangle',
                    color: isPremiumUser ? MAIN_COLOR : ERROR_COLOR
                });
                renderChatHistory();
            });
            
            wakeUpServer(); 
            updateUIState(); 
        };

        window.onload = init;
    </script>
</body>
</html>
