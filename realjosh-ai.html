<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>realJosh.AI Ultimate Chat V18 - Strakkere User Bubble</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #030712 100%);
        }
        .app-container {
            width: 100%;
            height: 100vh;
            max-width: 1000px;
            margin: 0 auto;
            border: none;
            box-shadow: none;
            transition: all 0.3s;
        }
        /* Aangepaste scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4f46e5;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6366f1;
        }
        .whitespace-pre-wrap {
            white-space: pre-wrap;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.85);
        }

        /* --- Gooey Indicator CSS V17 (Groter & Nieuwe Namen) --- */
        .gooey-indicator-container {
            display: flex;
            align-items: center;
            /* Hoogte aangepast aan de nieuwe SVG grootte */
            height: 60px; 
            padding: 0 10px;
            background: #1f2937;
            border-radius: 30px; /* Meer afgerond voor grotere grootte */
            border: 1px solid #374151;
            box-shadow: 0 0 12px rgba(79, 70, 229, 0.6); /* Meer schaduw */
        }

        .spinner-fluid-svg {
            /* De SVG is nu 60x60px */
            width: 60px; 
            height: 60px;
        }

        .fluid-shape-svg {
            /* Kleur blijft neon-indigo */
            fill: #6366f1; 
            transition: cx 0.5s cubic-bezier(0.3, 1.4, 0.4, 1),
                cy 0.5s cubic-bezier(0.3, 1.4, 0.4, 1),
                r 0.5s cubic-bezier(0.3, 1.4, 0.4, 1);
        }

        #spinner-fluid-group {
            /* Nieuwe ID */
            transform-origin: 100px 100px;
            transition: transform 0.5s linear;
        }
        /* --- Einde Gooey Indicator CSS --- */
    </style>
</head>
<body class="h-screen w-screen p-0 m-0 flex justify-center items-center">

    <div id="app-container" class="app-container flex flex-col h-full overflow-hidden bg-gray-900 shadow-2xl">

        <!-- Hoofdchatgebied -->
        <div class="flex-1 flex flex-col">

            <header class="bg-gray-950 p-4 sm:p-6 flex justify-center items-center border-b border-gray-800 flex-shrink-0 relative">
                <!-- Home Knop Links -->
                <div class="absolute left-4 sm:left-6 flex items-center space-x-3">
                    <a href="index.html" class="p-2 rounded-full text-white bg-indigo-700 hover:bg-indigo-600 transition duration-200 shadow-md flex items-center group">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 group-hover:scale-110 transition-transform"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 9 15 9 15 22"/></svg>
                        <span class="ml-2 hidden sm:inline">Home</span>
                    </a>
                </div>

                <!-- Titel Midden -->
                <div class="flex items-center">
                    <svg id="header-cpu-icon" class="w-8 h-8 mr-3 text-indigo-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="5" width="14" height="14" rx="2"/><path d="M15 9V7h-2V5H9v2H7v4h2v2H7v4h2v2h4v-2h2v-2h2v-4h-2v-2h2z"/></svg>
                    <h1 class="text-3xl font-extrabold text-white">
                        realJosh.<span class="text-indigo-400">AI</span>
                    </h1>
                </div>

                <!-- Instellingen Knop Rechts -->
                <div class="absolute right-4 sm:right-6">
                    <button id="settings-button" class="p-2 rounded-full text-white bg-gray-700 hover:bg-gray-600 transition duration-200 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 1-2 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 1-2 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 1 2 2h.44a2 2 0 0 0 2 2v.44a2 2 0 0 1 2 2h.44a2 2 0 0 0 2 2v.44a2 2 0 0 1 2 2h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 1 2-2h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 1 2-2h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 1-2-2h-.44a2 2 0 0 0-2-2v-.44a2 2 0 0 1-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                    </button>
                </div>

            </header>
            
            <div class="flex-1 p-4 sm:p-6 flex flex-col overflow-hidden bg-gray-900">
                <div id="chat-history-container" class="flex-1 overflow-y-auto pr-2 custom-scrollbar">
                    <div id="chat-end-ref"></div>
                </div>

                <form id="input-form" class="mt-4 flex flex-shrink-0">
                    <input
                        type="text"
                        id="prompt-input"
                        placeholder="Stel je vraag aan realJosh.ai..."
                        class="flex-1 p-4 rounded-l-xl bg-gray-800 text-white placeholder-gray-500 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 border-r-0 transition duration-200"
                        autofocus
                    />
                    <button
                        type="submit"
                        id="send-button"
                        class="p-4 rounded-r-xl text-white font-semibold flex items-center justify-center transition duration-300 transform active:scale-95 bg-gray-700 text-gray-500 cursor-not-allowed"
                        disabled
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-0 sm:mr-2"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
                        <span class="hidden sm:inline">Verstuur</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Instellingen Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-md z-10 border border-indigo-500/50">
            <h2 class="text-2xl font-bold text-white mb-4 border-b border-gray-700 pb-2">realJosh.AI Instellingen</h2>
            
            <!-- Vaste prompt uitleg (de system prompt is verborgen) -->
            <div class="mb-4 bg-gray-900 p-3 rounded-lg border border-gray-700">
                <p class="text-sm text-indigo-400 font-semibold mb-1">Vaste AI-Persoonlijkheid (Niet Verwijderbaar):</p>
                <p class="text-xs text-gray-400 italic">"Je bent een casual, vriendelijke en humoristische AI-assistent, zoals een jonge ontwikkelaar/gamer. Je gebruikt vaak de woorden 'yo', 'bro' en 'cool'."</p>
            </div>
            
            <div class="mb-6">
                <label for="custom-trait-input" class="block text-indigo-400 text-sm font-bold mb-2">Aanpasbare Trait (Extra Instructie):</label>
                <textarea id="custom-trait-input" rows="3" class="w-full p-3 rounded bg-gray-900 text-white border border-gray-700 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                <p class="text-xs text-gray-500 mt-1">Dit wordt als extra instructie aan de basis AI-persoonlijkheid toegevoegd en lokaal opgeslagen. Verwijder de tekst om de standaardwaarde te gebruiken.</p>
            </div>
            <div class="flex justify-between items-center space-x-3">
                <button id="reset-trait-button" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-500 transition duration-200 shadow-md flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2"><path d="M21.5 2v6h-6"/><path d="M2.5 22v-6h6"/><path d="M2.5 16a10 10 0 0 1 18.9-3.75L21.5 8"/><path d="M21.5 16a10 10 0 0 1-18.9 3.75L2.5 16"/></svg>
                    Reset Trait
                </button>
                <button id="save-trait-button" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-500 transition duration-200 shadow-md">
                    Opslaan & Sluiten
                </button>
            </div>
        </div>
    </div>
    <!-- Einde Instellingen Modal -->


    <script type="module">
        // Vaste configuratie voor de AI-persoonlijkheid (basisregel)
        const FIXED_PROMPT = "You are a helpful and friendly AI assistant named realJosh. Your personality is casual, friendly, and humorous, like a young developer or gamer. You must frequently use words like 'yo', 'bro' and 'cool'. You answer questions concisely. Respond in Dutch.";
        const DEFAULT_CUSTOM_TRAIT = "Probeer cool te doen.";
        
        // Local Storage Sleutel
        const TRAIT_STORAGE_KEY = 'customJoshTrait';

        // UI Elementen
        const chatContainer = document.getElementById('chat-history-container');
        const promptInput = document.getElementById('prompt-input');
        const sendButton = document.getElementById('send-button');
        const inputForm = document.getElementById('input-form');
        const chatEndRef = document.getElementById('chat-end-ref');
        const headerCpuIcon = document.getElementById('header-cpu-icon');
        
        // Modal Elementen
        const settingsButton = document.getElementById('settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const customTraitInput = document.getElementById('custom-trait-input');
        const resetTraitButton = document.getElementById('reset-trait-button');
        const saveTraitButton = document.getElementById('save-trait-button');

        // Globale App & State
        const ICON_MAP = { 
            Cpu: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><rect x="5" y="5" width="14" height="14" rx="2"/><path d="M15 9V7h-2V5H9v2H7v4h2v2H7v4h2v2h4v-2h2v-2h2v-4h-2v-2h2z"/></svg>', 
            AlertTriangle: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>', 
            MessageSquare: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>' 
        };
        let chatHistory = [];
        let isTyping = false;
        const MAIN_COLOR = 'text-indigo-400';
        const ACCENT_BUTTON_CLASSES = 'bg-indigo-600 hover:bg-indigo-500 shadow-lg';
        const ACCENT_CLASS_ARRAY = ACCENT_BUTTON_CLASSES.split(' ');
        const ERROR_COLOR = 'text-red-400';

        // Local State
        let customTraitState = DEFAULT_CUSTOM_TRAIT; 
        
        // Gooey Spinner State
        let animationIntervalId = null; 

        // API Configuratie
        const API_KEY = ""; // Blijft leeg voor Canvas
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;


        // --- LOCAL STORAGE FUNCTIES ---

        const loadCustomTrait = () => {
            const storedTrait = localStorage.getItem(TRAIT_STORAGE_KEY);
            customTraitState = storedTrait || DEFAULT_CUSTOM_TRAIT;
            console.log('Trait geladen uit LocalStorage:', customTraitState);
        };

        const saveCustomTrait = (newTrait) => {
            localStorage.setItem(TRAIT_STORAGE_KEY, newTrait);
            customTraitState = newTrait;
            console.log('Trait succesvol opgeslagen in LocalStorage:', newTrait);
        };
        
        // --- CHAT FUNCTIES ---

        const scrollToBottom = () => {
            chatEndRef.scrollIntoView({ behavior: "smooth" });
        };

        // Functie voor exponentiële backoff bij API-aanroepen
        const withExponentialBackoff = async (fn, maxRetries = 5) => {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    return await fn();
                } catch (error) {
                    if (attempt === maxRetries - 1) throw error;
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        };

        const callGeminiAPI = async (userPrompt) => {
            // Bouw de volledige System Prompt op (Vaste prompt + Aanpasbare trait)
            const fullSystemPrompt = `${FIXED_PROMPT} ${customTraitState}`;

            // Gebruik de chatHistory om context aan de AI te geven
            const historyForAPI = chatHistory
                .filter(msg => msg.sender !== 'ai' || !msg.text.startsWith('Een probleem') || !msg.text.startsWith('Cool! De Trait is bijgewerkt')) // Filter foutmeldingen/notificaties
                .map(msg => ({
                    role: msg.sender === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.text }]
                }));

            // Voeg de huidige prompt toe
            historyForAPI.push({ role: 'user', parts: [{ text: userPrompt }] });

            const payload = {
                contents: historyForAPI,
                tools: [{ "google_search": {} }], 
                systemInstruction: {
                    parts: [{ text: fullSystemPrompt }]
                }
            };
            
            const fetchContent = async () => {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API-fout: ${response.status}. Respons: ${errorBody}`);
                }

                return response.json();
            }

            try {
                const result = await withExponentialBackoff(fetchContent);

                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let text = candidate.content.parts[0].text;
                    let sources = [];

                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    if (sources.length > 0) {
                        const sourceList = sources
                            .map((a, index) => `[${index + 1}] <a href="${a.uri}" target="_blank" class="text-indigo-300 hover:text-indigo-200 underline">${a.title}</a>`)
                            .join('\n');

                        text += `\n\n---\n**Bronnen:**\n${sourceList}`;
                    }
                    return text;
                }
                
                return "Sorry, de AI gaf geen bruikbaar tekstresultaat terug.";

            } catch (error) {
                console.error("Fout in callGeminiAPI:", error);
                return `Een probleem is gedetecteerd met de Gemini API-aanroep. ${error.message}.`;
            }
        };


        const updateUIState = () => {
            const promptValue = promptInput.value.trim();
            const isReady = true; 

            if (isTyping || !promptValue || !isReady) {
                sendButton.disabled = true;
                sendButton.classList.remove(...ACCENT_CLASS_ARRAY); 
                sendButton.classList.add('bg-gray-700', 'text-gray-500', 'cursor-not-allowed');
            } else {
                sendButton.disabled = false;
                sendButton.classList.add(...ACCENT_BUTTON_CLASSES.split(' ')); 
                sendButton.classList.remove('bg-gray-700', 'text-gray-500', 'cursor-not-allowed');
            }

            promptInput.disabled = isTyping || !isReady;
            promptInput.placeholder = isTyping 
                ? "realJosh.ai is bezig met verwerken..." 
                : "Stel je vraag aan realJosh.ai...";

            if (isTyping) {
                 headerCpuIcon.classList.add('animate-spin');
            } else {
                headerCpuIcon.classList.remove('animate-spin');
            }
        };

        // --- GOOEY SPINNER LOGIC (Geïntegreerd JS) ---
        // Afstand in de 200x200 viewBox. Verdubbeld van 25 naar 50.
        const spacing = 50; 

        /**
         * Creëert een SVG cirkel (dot) met de nieuwe classnaam.
         */
        function createDot(svgGroup, cx, cy, r) {
            const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            dot.setAttribute("cx", cx);
            dot.setAttribute("cy", cy);
            dot.setAttribute("r", r);
            dot.classList.add("fluid-shape-svg"); // Nieuwe classnaam
            svgGroup.appendChild(dot);
            return dot;
        }

        /**
         * Voert de dynamische animatie van de gooey spinner uit.
         */
        function animateSpinner() {
            if (!isTyping) {
                return; 
            }
            
            // Nieuwe ID voor de groep
            const svgGroup = document.getElementById("spinner-fluid-group"); 
            if (!svgGroup) return;

            // Verwijder bestaande dots
            svgGroup.querySelectorAll(".fluid-shape-svg").forEach((dot) => dot.remove());

            // De start dot in het midden
            let centerDot = createDot(svgGroup, 100, 100, 6);

            const allDots = [];
            allDots.push(centerDot);
            
            // Kardinale richtingen (4 dots)
            const first4 = [
                { cx: 100, cy: 100 - spacing },
                { cx: 100, cy: 100 + spacing },
                { cx: 100 - spacing, cy: 100 },
                { cx: 100 + spacing, cy: 100 }
            ];

            // Animatie voor de eerste 4 dots
            first4.forEach((pos) => {
                const dot = createDot(svgGroup, 100, 100, 1);
                allDots.push(dot);
                const midX = (100 + pos.cx) / 2;
                const midY = (100 + pos.cy) / 2;
                setTimeout(() => {
                    if (!isTyping) return;
                    dot.setAttribute("r", 8);
                    dot.setAttribute("cx", midX);
                    dot.setAttribute("cy", midY);
                }, 50);
                setTimeout(() => {
                    if (!isTyping) return;
                    dot.setAttribute("r", 6);
                    dot.setAttribute("cx", pos.cx);
                    dot.setAttribute("cy", pos.cy);
                }, 500);
            });

            // Diagonalen (4 dots)
            setTimeout(() => {
                if (!isTyping) return;
                const diagSpacing = spacing / Math.sqrt(2);
                const diagonal = [
                    { cx: 100 - diagSpacing, cy: 100 - diagSpacing },
                    { cx: 100 + diagSpacing, cy: 100 - diagSpacing },
                    { cx: 100 - diagSpacing, cy: 100 + diagSpacing },
                    { cx: 100 + diagSpacing, cy: 100 + diagSpacing }
                ];
                diagonal.forEach((pos) => {
                    const dot = createDot(svgGroup, 100, 100, 1);
                    allDots.push(dot);
                    const midX = (100 + pos.cx) / 2;
                    const midY = (100 + pos.cy) / 2;
                    setTimeout(() => {
                        if (!isTyping) return;
                        dot.setAttribute("r", 8);
                        dot.setAttribute("cx", midX);
                        dot.setAttribute("cy", midY);
                    }, 1050); 
                    setTimeout(() => {
                        if (!isTyping) return;
                        dot.setAttribute("r", 6);
                        dot.setAttribute("cx", pos.cx);
                        dot.setAttribute("cy", pos.cy);
                    }, 1500);
                });
            }, 1000);

            // Roteer de hele groep
            setTimeout(() => {
                if (!isTyping) return;
                svgGroup.style.transform = "rotate(360deg)";
            }, 2500);

            // Terug naar één dot (dots bewegen terug naar het midden)
            setTimeout(() => {
                if (!isTyping) return;
                svgGroup.style.transition = "transform 0.5s linear";
                svgGroup.style.transform = "rotate(0deg)";
                allDots.forEach((dot) => {
                    dot.setAttribute("cx", 100);
                    dot.setAttribute("cy", 100);
                    dot.setAttribute("r", 6);
                });
            }, 3000);
            
            // Loop opnieuw
            animationIntervalId = setTimeout(() => {
                if (isTyping) {
                    animateSpinner();
                } else {
                    svgGroup.querySelectorAll(".fluid-shape-svg").forEach((dot) => dot.remove()); // Laatste opruiming
                }
            }, 4000); 
        }

        /**
         * Stopt de spinner animatie en ruimt op.
         */
        const stopSpinner = () => {
            if (animationIntervalId) {
                clearTimeout(animationIntervalId);
                animationIntervalId = null;
            }
            const svgGroup = document.getElementById("spinner-fluid-group");
            if (svgGroup) {
                svgGroup.querySelectorAll(".fluid-shape-svg").forEach((dot) => dot.remove());
            }
        };

        // --- EINDE GOOEY SPINNER LOGIC ---


        const renderTypingIndicator = (show) => {
            const existingIndicator = document.getElementById('typing-indicator');
            if (!show) {
                if (existingIndicator) existingIndicator.remove();
                stopSpinner();
                return;
            }

            if (existingIndicator) return; 
            
            const indicator = document.createElement('div');
            indicator.id = 'typing-indicator';
            indicator.className = 'flex justify-start items-center mb-4 p-2';
            
            // V17: Grotere Gooey Indicator SVG (60x60px)
            indicator.innerHTML = `
                <div class="p-2 rounded-full mr-3 bg-gray-700 shadow-md flex-shrink-0 ${MAIN_COLOR}">
                    ${ICON_MAP.Cpu}
                </div>
                <div class="gooey-indicator-container">
                    <svg viewBox="0 0 200 200" class="spinner-fluid-svg">
                        <defs>
                            <filter id="gooey-filter-id">
                                <feGaussianBlur in="SourceGraphic" stdDeviation="6" result="blur" />
                                <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0
                                    0 1 0 0 0
                                    0 0 1 0 0
                                    0 0 0 20 -10" result="goo" />
                                <feBlend in="SourceGraphic" in2="goo" />
                            </filter>
                        </defs>
                        <g id="spinner-fluid-group" filter="url(#gooey-filter-id)">
                            <!-- Dots worden via JavaScript hierin gecreëerd en geanimeerd -->
                        </g>
                    </svg>
                </div>
            `;
            chatContainer.insertBefore(indicator, chatEndRef);
            
            // Start de animatie nadat de elementen in de DOM zijn
            setTimeout(() => {
                if(isTyping) animateSpinner();
            }, 0); 

            scrollToBottom();
        };


        const renderMessage = (msg) => {
             const messageEl = document.createElement('div');
            
            const { sender, text, icon: iconName, color } = msg;

            const isError = iconName === 'AlertTriangle';

            const iconSvg = ICON_MAP[iconName] || ICON_MAP.MessageSquare; 
            const iconClass = color || MAIN_COLOR;
            const bgColor = isError ? 'bg-red-800 border-red-700' : 'bg-gray-800 border-gray-700';
            
            if (sender === 'user') {
                messageEl.className = 'flex mb-4 p-2 justify-end';
                // WIJZIGING: p-3 is gewijzigd naar p-2 voor nog strakkere bubble
                messageEl.innerHTML = `
                    <div class="inline-block max-w-[80%] sm:max-w-xl p-2 rounded-xl shadow-lg transition duration-300 bg-indigo-600 text-white rounded-br-none whitespace-pre-wrap">
                        <p>${text}</p>
                    </div>
                `;
            } else { 
                messageEl.className = 'flex mb-4 p-2 justify-start';
                // AI bubble blijft op p-4
                messageEl.innerHTML = `
                    <div class="p-2 rounded-full mr-3 bg-gray-700 shadow-md flex-shrink-0 ${iconClass}">
                        ${iconSvg}
                    </div>
                    <div class="inline-block max-w-[80%] sm:max-w-xl p-4 rounded-xl shadow-lg transition duration-300 ${bgColor} text-gray-200 rounded-tl-none border">
                        <p class="whitespace-pre-wrap">${text}</p>
                    </div>
                `;
            }
            chatContainer.insertBefore(messageEl, chatEndRef);
        };

        const renderChatHistory = () => {
            // Verwijder alle berichten behalve de 'chat-end-ref' en de 'typing-indicator'
            Array.from(chatContainer.children).forEach(child => {
                if (child.id !== 'chat-end-ref' && child.id !== 'typing-indicator') {
                    child.remove();
                }
            });
            
            chatHistory.forEach(renderMessage);
            scrollToBottom();
        };

        const handleSend = async (e) => {
            e.preventDefault();
            const cleanPrompt = promptInput.value.trim();
            const isReady = true; 

            if (!cleanPrompt || isTyping || !isReady) return;

            const userMessage = { sender: 'user', text: cleanPrompt };
            chatHistory.push(userMessage);
            promptInput.value = '';

            isTyping = true;
            renderChatHistory(); 
            renderTypingIndicator(true); 
            updateUIState();

            try {
                const aiText = await callGeminiAPI(cleanPrompt);
                
                let aiMessage;
                if (aiText.startsWith('Een probleem is gedetecteerd') || aiText.startsWith('Sorry, de AI gaf geen bruikbaar')) {
                    aiMessage = { 
                        sender: 'ai', 
                        text: aiText, 
                        icon: 'AlertTriangle', 
                        color: ERROR_COLOR 
                    };
                } else {
                    aiMessage = { 
                        sender: 'ai', 
                        text: aiText, 
                        icon: 'Cpu', 
                        color: MAIN_COLOR 
                    };
                }
                
                chatHistory.push(aiMessage);

            } catch (error) {
                console.error("Fatale fout in handleSend:", error);
                const fatalError = { 
                    sender: 'ai', 
                    text: `Yo, er is een *epic fail* opgetreden: ${error.message}. Dit is niet cool, bro.`, 
                    icon: 'AlertTriangle', 
                    color: ERROR_COLOR 
                };
                chatHistory.push(fatalError);
            } finally {
                isTyping = false;
                renderTypingIndicator(false);
                renderChatHistory(); 
                updateUIState();
            }
        };

        // --- MODAL FUNCTIES ---
        const openSettingsModal = () => {
            // Zorg ervoor dat de input de huidige opgeslagen staat weergeeft
            customTraitInput.value = customTraitState === DEFAULT_CUSTOM_TRAIT ? "" : customTraitState;
            settingsModal.classList.remove('hidden');
        };

        const closeSettingsModal = () => {
            settingsModal.classList.add('hidden');
        };

        const handleSaveTrait = () => {
            const newTrait = customTraitInput.value.trim() || DEFAULT_CUSTOM_TRAIT;
            if (newTrait !== customTraitState) {
                saveCustomTrait(newTrait); // Sla op in localStorage
                
                // Update de chat met een melding over de verandering
                chatHistory.push({
                    sender: 'ai',
                    text: `Cool! De Trait is bijgewerkt naar: "${newTrait}". Dit wordt gebruikt voor alle toekomstige antwoorden. Geef de chat een slinger!`,
                    icon: 'Cpu',
                    color: MAIN_COLOR
                });
                renderChatHistory();
            }
            closeSettingsModal();
        };

        const handleResetTrait = () => {
            customTraitInput.value = DEFAULT_CUSTOM_TRAIT;
        };

        const initApp = () => {
            loadCustomTrait();

            chatHistory = [
                {
                    sender: 'ai',
                    text: `Yo, bro, wat is de vibe? Vraag me alles wat je wilt weten!`, 
                    icon: 'Cpu',
                    color: MAIN_COLOR
                }
            ];
            
            renderChatHistory();

            // Event Listeners
            inputForm.addEventListener('submit', handleSend);
            promptInput.addEventListener('input', updateUIState);
            settingsButton.addEventListener('click', openSettingsModal);
            saveTraitButton.addEventListener('click', handleSaveTrait);
            resetTraitButton.addEventListener('click', handleResetTrait);
            settingsModal.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    closeSettingsModal();
                }
            });
            
            updateUIState();
        };

        window.onload = initApp;
    </script>
</body>
</html>
